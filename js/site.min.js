const _APP_VERSION="2024.11.07.2",_STORE_NAME_BIBLE="BibleStore",_STORE_NAME_BIBLE_SUMMARY="BibleSummaryStore",_STORE_NAME_PLAN="PlanStore",_STORE_NAME_READING_HISTORICAL="ReadingHistoricalStore",_STORE_NAME_READING_THEME="ReadingThemeStore",_STORE_NAME_READING_TOPIC="ReadingTopicStore",_STORE_NAME_READING_MIXED="ReadingMixedStore",_STORE_NAME_READING_RECORD="ReadingRecordStore",_LOCAL_STORAGE_BIBLE_BOOK="#DB_BOOK",_LOCAL_STORAGE_BIBLE_BOOKNAME="#DB_BOOKNAME",_LOCAL_STORAGE_BIBLE_CHAPTER="#DB_CHAPTER",_LOCAL_STORAGE_SETTING_CHECKED="#CHECKED",_LOCAL_STORAGE_SETTING_FONT_SIZE="#FONT_SIZE";let _currentStep=1;const _totalSteps=3;function InitPage(){InitSettingPopup(),$(".modal").modal(),$("#btn-settings").sideNav({edge:"right",onOpen:function(){history.pushState({page:"sidenav"},"sidenav","#sidenav")},onClose:function(){history.state&&"sidenav"===history.state.page&&history.back()}}),$(".simplebar").each(function(){new SimpleBar(this)}),window.addEventListener("load",fnResizeHeight),window.addEventListener("resize",fnResizeHeight),$("#myfamily").on("dblclick",ShowEffectByLove),$("#_version").on("dblclick",OnResetApp),window.addEventListener("popstate",function(e){$(".popup").hasClass("active")?CloseAllPopup():$("#sidenav-overlay").length>0&&CloseSettingPopup(),e.preventDefault()})}function isShowIntroPopup(){return!sessionStorage.getItem("#popup-intro")}async function InitDB(){try{let e=await DBHelper.fnCheckDBExists();e?(console.log("DB가 이미 존재합니다."),DBHelper.fnCheckStoreHasData(_STORE_NAME_PLAN).then(e=>{e?($("#popup-intro").removeClass("active"),sessionStorage.setItem("#popup-intro","true"),OnLoadAndBindingPlan(ToggleCompletedPlan)):$("#popup-intro").addClass("active")})):(console.log("DB가 존재하지 않으므로 초기화 및 데이터 로드를 시작합니다."),$("#popup-intro").addClass("active"))}catch(t){DBHelper.fnDeleteDB(),toast("DB 처리 중 오류 발생 <br> 새고로침 후 다시 시도해주세요.")}}async function OnSetupDB(){try{let e=await DBHelper.fnCheckDBExists();if(e){OpenPlanPopup();return}await DBHelper.fnInitDB([{name:_STORE_NAME_BIBLE,keyPath:"idx",indices:[{name:"cate",keyPath:"cate",unique:!1},{name:"book",keyPath:"book",unique:!1},{name:"chapter",keyPath:"chapter",unique:!1},{name:"book_chapter",keyPath:["book","chapter"],unique:!1}]},{name:_STORE_NAME_BIBLE_SUMMARY,keyPath:"book",indices:[{name:"long_label",keyPath:"long_label",unique:!1},{name:"short_label",keyPath:"short_label",unique:!1},{name:"chapter_count",keyPath:"chapter_count",unique:!1},{name:"cate",keyPath:"cate",unique:!1}]},{name:_STORE_NAME_PLAN,keyPath:"key"},{name:_STORE_NAME_READING_HISTORICAL,keyPath:null,autoIncrement:!0,indices:[{name:"book",keyPath:"book",unique:!1},{name:"chapter",keyPath:"chapter",unique:!1},{name:"long_label",keyPath:"long_label",unique:!1},{name:"category",keyPath:"category",unique:!1}]},{name:_STORE_NAME_READING_THEME,keyPath:null,autoIncrement:!0,indices:[{name:"book",keyPath:"book",unique:!1},{name:"chapter",keyPath:"chapter",unique:!1},{name:"long_label",keyPath:"long_label",unique:!1},{name:"category",keyPath:"category",unique:!1}]},{name:_STORE_NAME_READING_TOPIC,keyPath:null,autoIncrement:!0,indices:[{name:"book",keyPath:"book",unique:!1},{name:"chapter",keyPath:"chapter",unique:!1},{name:"long_label",keyPath:"long_label",unique:!1},{name:"category",keyPath:"category",unique:!1}]},{name:_STORE_NAME_READING_MIXED,keyPath:null,autoIncrement:!0,indices:[{name:"book",keyPath:"book",unique:!1},{name:"chapter",keyPath:"chapter",unique:!1},{name:"long_label",keyPath:"long_label",unique:!1},{name:"category",keyPath:"category",unique:!1}]},{name:"ReadingRecordStore",keyPath:null,autoIncrement:!0,indices:[{name:"book",keyPath:"book",unique:!1},{name:"chapter",keyPath:"chapter",unique:!1},{name:"verse",keyPath:"verse",unique:!1}]}]),console.log("DB 초기화 완료. 이제 JSON 데이터를 로드합니다."),$("body").append('<aside id="_download" class="active"><section><p>잠시만 기다려주세요^^</p><h1>0%</h1><div class="bar"><i></i></div></section></aside>');let t=[{filePath:"/data/bible_db.json",storeName:_STORE_NAME_BIBLE,keyPath:"Bible"},{filePath:"/data/bible_db.summary.json",storeName:_STORE_NAME_BIBLE_SUMMARY,keyPath:"oldTestament"},{filePath:"/data/bible_db.summary.json",storeName:_STORE_NAME_BIBLE_SUMMARY,keyPath:"newTestament"},{filePath:"/data/historicalOrder_db.json",storeName:_STORE_NAME_READING_HISTORICAL},{filePath:"/data/themeOrder_db.json",storeName:_STORE_NAME_READING_THEME},{filePath:"/data/topicOrder_db.json",storeName:_STORE_NAME_READING_TOPIC},{filePath:"/data/mixedOrder_db.json",storeName:_STORE_NAME_READING_MIXED}],a=0,n=[];for(let o of t){let i=await fetch(o.filePath).then(e=>e.json()),l=o.keyPath?i[o.keyPath]:i,r=Array.isArray(l)?l.length:0;n.push(r),a+=r}let p=0;for(let c=0;c<t.length;c++){let s=t[c],d=n[c];await DBHelper.fnLoadAndSaveJSON(s.filePath,s.storeName,s.keyPath,e=>{let t=e/100*d,n=Math.floor((p+t)/a*100);_(n)}),p+=d}function _(e){$("#_download section p").text("Downloading..."),$("#_download h1").text(e+"%"),$("#_download .bar > i").css("width",e+"%")}console.log("DB에 데이터 저장 완료."),await fnDelay(300),$("#_download").removeClass("active"),OpenPlanPopup()}catch(u){DBHelper.fnDeleteDB(),toast("DB 처리 중 오류 발생 <br> 새고로침 후 다시 시도해주세요.")}}function InitSettingPopup(){$("#_version").text("VER_2024.11.07.2");let e=fnNull(localStorage.getItem(_LOCAL_STORAGE_SETTING_FONT_SIZE),"1.8rem");e&&(ChangeFontSize(e),$(`input[name=radio-font][value='${e}']`).prop("checked",!0)),$("input[name=radio-font]").change(function(){let e=$(this).val();ChangeFontSize(e),localStorage.setItem(_LOCAL_STORAGE_SETTING_FONT_SIZE,e)});let t=localStorage.getItem(_LOCAL_STORAGE_SETTING_CHECKED);t&&$("#chk-completed").prop("checked","true"===t),$("#chk-completed").change(function(){let e=$(this).prop("checked");localStorage.setItem(_LOCAL_STORAGE_SETTING_CHECKED,e),ToggleCompletedPlan()})}async function OnLoadAndBindingPlan(e=null){try{console.log("OnLoadAndBindingPlan");let t=await DBHelper.fnGetAllData(_STORE_NAME_PLAN);if(0===t.length)return;let a=t[0].data;console.log("계획 데이터:",a),console.log(a.readingMethod);let n=$("#plan-list");n.empty();let o=null,i=null;a.plan.forEach(e=>{let[t,a,l]=e.date.split(".");if(o!==a){o=a,i&&n.append(i);let r=$(`<h4>20${t}년 ${parseInt(a)}월 <b>${e.category}<b></h4>`);n.append(r),i=$("<table></table>")}let p=e.completed?"active":"",c=e.newweek?" split":"",s="";(p||c)&&(s=`class="${p}${c}"`);let d=""===e.category?"<i>✔</i>":`<b>${e.category}</b>`;i.append(`<tr ${s} data-date="${e.date}"><td>${e.day}</td><td>${e.date}</td><td>${e.bible}</td><td>${d}</td></tr>`)}),i&&n.append(i),OnBindingPlanAfterProc(a,!e),e&&e()}catch(l){console.error("계획 조회 중 오류 발생:",l),toast("계획 조회 중 오류가 발생했습니다. 다시 시도해주세요.")}}function OnBindingPlanAfterProc(e,t=!0){let a=calculateRemainingTasks(e),n=calculateCompletionRate(e),o=$("#slide-settings .info");o.find(".info-title").html(`계획표 기간 <small class="op-5">(${e.readingDurationName})</small>`),o.find(".info-days").text(`${a}건 남음`),o.find(".info-date").text(`${e.startDate} ~ ${e.endDate}`),$("#title-plan").text(`${e.readingMethodName}`),updateCompletionRateUI(n),t&&focusFirstUncheckedItem();let i="true"===localStorage.getItem(_LOCAL_STORAGE_SETTING_CHECKED);$("#completed").removeClass("active"),0===a&&i&&$("#completed").addClass("active")}function calculateRemainingTasks(e){let t=e.plan.filter(e=>!e.completed).length;return t}function calculateCompletionRate(e){let t=e.plan.length,a=e.plan.filter(e=>e.completed).length;return(a/t*100).toFixed(2)}function updateCompletionRateUI(e){let t=document.querySelector("#header.plan-progress-bar");t&&t.style.setProperty("--completion-rate",`${e}%`)}function focusFirstUncheckedItem(){let e=$("#plan-list tr").not(".active").first();console.log(e),e.length&&e[0].scrollIntoView({behavior:"smooth",block:"center"})}async function OnSavePlan(e){console.log(e);let t=await PlanHelper.fnSaveReadingPlan(e);OnBindingPlanAfterProc(t.data);let a=calculateRemainingTasks(t.data);0===a&&(alert("축하합니다!\n성경 통독을 완료하셨습니다.\n하나님의 은혜가 함께하시길 소망합니다."),ShowEffectByEnd())}function OnResetPlan(){_currentStep=1,$('input[type="radio"]:not([name=radio-font])').prop("checked",!1),$('input[type="checkbox"]').prop("checked",!0),$("#prevStep").prop("disabled",!0),$("#nextStep").prop("disabled",!1),OnShowStep()}function OnShowStep(){$(".step").addClass("none"),$(`.step.s${_currentStep}`).removeClass("none").fadeIn(300*_currentStep),$("#stepCount").text(_currentStep),3===_currentStep?($("#nextStep").hide(),$("#btnGenerate").show()):($("#nextStep").show(),$("#btnGenerate").hide(),1===_currentStep?$("#prevStep").prop("disabled",!0):$("#prevStep").prop("disabled",!1))}function IsValidateStep(){if(1===_currentStep){if(0===$("input[name='chk1']:checked").length)return toast("읽기 방식을 선택해주세요."),!1}else if(2===_currentStep){if(0===$('input[name="chk2"]:checked').length)return toast("최소 하나의 요일을 선택해주세요."),!1}else if(3===_currentStep&&0===$('input[name="chk3"]:checked').length)return toast("읽기 기간을 선택해주세요."),!1;return!0}function OnNextPlanStep(){if(!1!==IsValidateStep()){if(3==++_currentStep){let e=$('input[name="chk2"]:checked').map(function(){return $(this).val()}).get();$("._w").text("(매일)"),e.length<7&&$("._w").text(`(${e.join(", ")})`),$('input[name="chk3"]').each(function(){let t=parseInt($(this).val()),a=PlanHelper.fnCalculateAverageTime(t,e.length);$(this).parent().find(".time-display").html(`<strong>${a.hours}시간 ${a.minutes}분</strong>`.replace("0시간",""))})}OnShowStep()}}function OnPrevPlanStep(){1!==_currentStep&&(_currentStep--,OnShowStep())}async function OnCreatePlan(){try{if(!1===IsValidateStep())return;let e=$("input[name='chk1']:checked").val(),t=$('input[name="chk2"]:checked').map(function(){return $(this).val()}).get(),a=parseInt($("input[name='chk3']:checked").val());await PlanHelper.fnCreatePlanData(e,t,a),await OnLoadAndBindingPlan(),CloseAllPopup(),setTimeout(ShowEffectByStart,500)}catch(n){console.error("계획 생성 중 오류 발생:",n),toast("계획 생성 중 오류가 발생했습니다. 다시 시도해주세요.")}}async function OnHistoryBible(){let e=fnNull(localStorage.getItem(_LOCAL_STORAGE_BIBLE_BOOK),""),t=fnNull(localStorage.getItem(_LOCAL_STORAGE_BIBLE_BOOKNAME),""),a=fnNull(localStorage.getItem(_LOCAL_STORAGE_BIBLE_CHAPTER),"");a&&e?await OnLoadVerses(parseInt(e),t,parseInt(a)):e?await OnLoadChapters(parseInt(e),t):OnLoadBooks()}async function OnLoadBooks(){console.log("OnLoadBooks"),$("#bibles").show(),$("#bible-list").hide(),OnUpdateNav(0)}async function OnLoadChapters(e,t=null){console.log("OnLoadChapters"),$("#bibles").hide(),$("#bible-list").show();try{console.log("선택한 성경책:",e,t);var a=await DBHelper.fnGetDataByKey(_STORE_NAME_BIBLE_SUMMARY,e);if(!a){console.log("해당 책에 대한 정보가 없습니다.");return}OnUpdateNav(1,e,t),console.log("장 목록:",a.chapter_count),$("#bible-list").empty(),$("#bible-list").append(`<h4>${t}</h4>`).append("<ul>");for(let n=1;n<=a.chapter_count;n++){let o=$("<li></li>").text(`${n}장`);o.on("click",()=>OnLoadVerses(e,t,n)),$("#bible-list ul").append(o)}}catch(i){console.error("Error selecting Bible book:",i)}}async function OnLoadVerses(e,t,a){console.log("OnLoadVerses"),$("#bibles").hide(),$("#bible-list").show();try{let n=await DBHelper.fnGetDataByIndex(_STORE_NAME_BIBLE,"book_chapter",[e,a]);if(!n||0===n.length){console.log("해당 장에 대한 정보가 없습니다.");return}OnUpdateNav(2,e,t,a),console.log("절 목록:",n),$("#bible-list").empty(),n.forEach(e=>{$("#bible-list").append(`<p data-idx="${e.idx}"><sup>${e.paragraph}</sup>${e.sentence}</p>`)})}catch(o){console.error("Error fetching chapter data:",o)}}function OnUpdateNav(e=0,t=null,a=null,n=null){let o=$("#bible-nav").empty();0===e?o.append($("<a href='javascript:;'></a>").text("전체")):1===e?(o.append($("<a href='javascript:;'></a>").text("전체").on("click",OnLoadBooks)),o.append($("<a href='javascript:;'></a>").text(a))):2===e&&(o.append($("<a href='javascript:;'></a>").text("전체").on("click",OnLoadBooks)),o.append($("<a href='javascript:;'></a>").text(a).on("click",()=>OnLoadChapters(t,a))),o.append($("<a href='javascript:;'></a>").text(`${n}장`))),localStorage.setItem(_LOCAL_STORAGE_BIBLE_BOOK,t),localStorage.setItem(_LOCAL_STORAGE_BIBLE_BOOKNAME,a),localStorage.setItem(_LOCAL_STORAGE_BIBLE_CHAPTER,n)}function fnResizeHeight(){let e=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${e}px`)}function OpenPlanPopup(){OnResetPlan(),$("#popup-plan").addClass("active"),history.pushState({page:"popup"},"popup","#popup")}function OpenHelpPopup(){$("#popup-help").addClass("active"),history.pushState({page:"popup"},"popup","#popup")}function CloseAllPopup(){$(".popup").removeClass("active"),history.state&&"popup"===history.state.page&&history.back()}function ClosePopup(e){$(e).parents(".popup").removeClass("active"),history.state&&"popup"===history.state.page&&history.back()}function CloseSettingPopup(){$("#btn-settings").sideNav("hide")}function ChangeFontSize(e){document.documentElement.style.setProperty("--fs",e)}function ToggleCompletedPlan(){let e="true"===localStorage.getItem(_LOCAL_STORAGE_SETTING_CHECKED),t=$("#plan-list table");t.each(function(){let t=$(this),a=t.find("tr"),n=t.find("tr.active"),o=t.prev("h4");a.length===n.length?e?(t.hide(),o.hide()):(t.show(),o.show()):(e?n.hide():n.show(),t.show(),o.show())}),$("#completed").removeClass("active"),e?e&&0===$("#plan-list table tr:not(.active)").length&&$("#completed").addClass("active"):focusFirstUncheckedItem()}function ShowEffectByStart(){confetti({particleCount:fnRandomInt(200,250),startVelocity:fnRandomInt(50,60),spread:fnRandomInt(120,150),origin:{y:fnRandomFloat(.5,.8)}})}function ShowEffectByEnd(){var e=Date.now()+7e3,t={startVelocity:30,spread:360,ticks:60,zIndex:0};function a(e,t){return Math.random()*(t-e)+e}var n=setInterval(function(){var o=e-Date.now();if(o<=0)return clearInterval(n);var i=50*(o/7e3);confetti({...t,particleCount:i,origin:{x:a(.1,.3),y:Math.random()-.2}}),confetti({...t,particleCount:i,origin:{x:a(.7,.9),y:Math.random()-.2}})},250)}function ShowEffectByLove(){CloseAllPopup();var e=confetti.shapeFromPath({path:"M449.4 142c-5 0-10 .3-15 1a183 183 0 0 0-66.9-19.1V87.5a17.5 17.5 0 1 0-35 0v36.4a183 183 0 0 0-67 19c-4.9-.6-9.9-1-14.8-1C170.3 142 105 219.6 105 315s65.3 173 145.7 173c5 0 10-.3 14.8-1a184.7 184.7 0 0 0 169 0c4.9.7 9.9 1 14.9 1 80.3 0 145.6-77.6 145.6-173s-65.3-173-145.7-173zm-220 138 27.4-40.4a11.6 11.6 0 0 1 16.4-2.7l54.7 40.3a11.3 11.3 0 0 1-7 20.3H239a11.3 11.3 0 0 1-9.6-17.5zM444 383.8l-43.7 17.5a17.7 17.7 0 0 1-13 0l-37.3-15-37.2 15a17.8 17.8 0 0 1-13 0L256 383.8a17.5 17.5 0 0 1 13-32.6l37.3 15 37.2-15c4.2-1.6 8.8-1.6 13 0l37.3 15 37.2-15a17.5 17.5 0 0 1 13 32.6zm17-86.3h-82a11.3 11.3 0 0 1-6.9-20.4l54.7-40.3a11.6 11.6 0 0 1 16.4 2.8l27.4 40.4a11.3 11.3 0 0 1-9.6 17.5z",matrix:[.020491803278688523,0,0,.020491803278688523,-7.172131147540983,-5.9016393442622945]}),t=confetti.shapeFromPath({path:"M120 240c-41,14 -91,18 -120,1 29,-10 57,-22 81,-40 -18,2 -37,3 -55,-3 25,-14 48,-30 66,-51 -11,5 -26,8 -45,7 20,-14 40,-30 57,-49 -13,1 -26,2 -38,-1 18,-11 35,-25 51,-43 -13,3 -24,5 -35,6 21,-19 40,-41 53,-67 14,26 32,48 54,67 -11,-1 -23,-3 -35,-6 15,18 32,32 51,43 -13,3 -26,2 -38,1 17,19 36,35 56,49 -19,1 -33,-2 -45,-7 19,21 42,37 67,51 -19,6 -37,5 -56,3 25,18 53,30 82,40 -30,17 -79,13 -120,-1l0 41 -31 0 0 -41z",matrix:[.03597122302158273,0,0,.03597122302158273,-4.856115107913669,-5.071942446043165]}),a=confetti.shapeFromPath({path:"M167 72c19,-38 37,-56 75,-56 42,0 76,33 76,75 0,76 -76,151 -151,227 -76,-76 -151,-151 -151,-227 0,-42 33,-75 75,-75 38,0 57,18 76,56z",matrix:[.03333333333333333,0,0,.03333333333333333,-5.566666666666666,-5.533333333333333]}),n={scalar:2,spread:180,particleCount:30,origin:{y:-.1},startVelocity:-35};confetti({...n,shapes:[e],colors:["#ff9a00","#ff7400","#ff4d00"]}),confetti({...n,shapes:[t],colors:["#8d960f","#be0f10","#445404"]}),confetti({...n,shapes:[a],colors:["#f93963","#a10864","#ee0b93"]})}function OnShareApp(){fnShareLink("날마다성경","성경 통독 계획표를 만들고,날마다 성경을 읽어보세요.","https://nalmada.netlify.app","app.netlify.nalmada.twa")}function OnResetApp(){confirm("데이터를 정말 초기화 하시겠습니까?")&&(DBHelper.fnDeleteDB().then(()=>{console.log("DB 삭제 완료"),localStorage.clear()}).catch(e=>{console.error("DB 삭제 실패:",e)}),setTimeout(()=>{alert("초기화 되었습니다."),location.reload()},1500))}function TestPlan(){}document.addEventListener("DOMContentLoaded",InitPage);