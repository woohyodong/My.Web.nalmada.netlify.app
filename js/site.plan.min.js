const PlanHelper=function(){let e="myPlan",t={readingMethod:null,readingMethodName:null,readingDays:[],readingDuration:null,readingDurationName:"",startDate:null,endDate:null,plan:[]};async function a(a,r,n){try{var s,c,p,h;t.readingMethod=null,t.readingMethodName=null,t.readingDays=[],t.readingDuration=null,t.startDate=null,t.endDate=null,t.plan=[],t.readingMethod=a,t.readingDays=r,t.readingDuration=n,t.readingDurationName=function e(t){switch(t){case 90:return"3개월";case 180:return"6개월";case 360:return"1년";case 540:return"1년 6개월";case 720:return"2년";default:return`${t} 일간`}}(n),t.startDate=new Date;let f=await (s=n,new Promise(e=>{let a=new Date,r=0;for(;s>0;){let n=u(a.getDay());t.readingDays.includes(n)&&r++,a.setDate(a.getDate()+1),s--}e(r)})),g;switch(a){case"01":t.readingMethodName="성경 순서로 읽기",g=await DBHelper.fnGetAllData(_STORE_NAME_BIBLE_SUMMARY),t.plan=await (c=g,p=f,new Promise((e,a)=>{let r=[],n=new Date(t.startDate);if(isNaN(n.getTime())){console.error("Invalid start date after conversion:",n),a("Invalid start date after conversion.");return}let l=c,s=Math.ceil(l.reduce((e,t)=>e+t.verses.reduce((e,t)=>e+t,0),0)/p),h=0,f=0,g=d(n);for(l.forEach(e=>{e.currentChapter=1,e.currentVerse=1});f<p&&h<l.length;){let $=n.getDay(),D=d(n),_=u($),w=o(n);if(t.readingDays.includes(_)){let m=[],y=!1,v=s;for(D!==g&&(y=!0,g=D);v>0&&h<l.length;){let b=l[h],k=b.verses[b.currentChapter-1]||0,M=b.currentVerse,N=b.currentChapter,E=M,R=N,C=k;v>=k-M+1?(v-=k-M+1,b.currentChapter++,b.currentVerse=1):(C=M+v-1,b.currentVerse=C+1,v=0),m.push(`${b.long_label} ${N}:${E} ~ ${R}:${C}`),b.currentChapter>b.chapter_count&&h++}let G=i(m);G.length>0&&(r.push({date:w,day:_,bible:G,completed:!1,newweek:y,category:""}),f++)}n.setDate(n.getDate()+1)}r.length>0?e(r):(console.warn("No plan data was generated."),e([]))}));break;case"02":t.readingMethodName="역사 순서로 읽기",g=await DBHelper.fnGetAllData(_STORE_NAME_READING_HISTORICAL),t.plan=await l(g,f);break;case"03":t.readingMethodName="테마 순서로 읽기",g=await DBHelper.fnGetAllData(_STORE_NAME_READING_THEME),t.plan=await l(g,f);break;case"04":t.readingMethodName="주제 순서로 읽기",g=await DBHelper.fnGetAllData(_STORE_NAME_READING_TOPIC),t.plan=await l(g,f);break;case"05":t.readingMethodName="구약/신약 혼합해서 읽기",g=await DBHelper.fnGetAllData(_STORE_NAME_READING_MIXED),t.plan=await l(g,f);break;case"00":t.readingMethodName="내가 읽은 성경만 기록",g=await DBHelper.fnGetAllData(_STORE_NAME_BIBLE_SUMMARY),t.plan=await (h=g,new Promise((e,t)=>{let a=[];h.forEach(e=>{let t=[];for(let r=1;r<=e.chapter_count;r++)t.push({chapter:r,versesRead:[],totalVerses:e.verses[r-1],completed:!1});a.push({book:e.book,long_label:e.long_label,short_label:e.short_label,category:e.category,totalChapters:e.chapter_count,chaptersRead:t,totalVerses:e.verses.reduce((e,t)=>e+t,0),versesReadCount:0,verses:e.verses,completed:!1})}),a.length>0?e(a):t("No plan data was generated.")}));break;default:t.readingMethodName="날마다 성경 읽기"}"00"===a?(t.startDate=o(t.startDate),await DBHelper.fnSaveData(_STORE_NAME_PLAN,{key:e,data:t})):t.plan.length>0&&(t.endDate=t.plan[t.plan.length-1].date,t.startDate=o(t.startDate),await DBHelper.fnSaveData(_STORE_NAME_PLAN,{key:e,data:t})),console.log("_planData",t)}catch($){throw $}}async function r(t,a,r){try{let n=await DBHelper.fnGetDataByKey(_STORE_NAME_PLAN,e),l=n.data.plan.find(e=>e.book===t);if(!l){console.error("해당 책을 찾을 수 없습니다.");return}let i=l.chaptersRead.find(e=>e.chapter===a);if(!i){console.error("해당 장을 찾을 수 없습니다.");return}r.forEach(e=>{i.versesRead.includes(e)||i.versesRead.push(e)}),i.versesRead.length===i.totalVerses&&(i.completed=!0),l.versesReadCount=l.chaptersRead.reduce((e,t)=>e+t.versesRead.length,0),l.versesReadCount===l.totalVerses&&(l.completed=!0),console.log("bookEntry",l),await DBHelper.fnSaveData(_STORE_NAME_PLAN,n),console.log("성공적으로 읽은 구절을 기록했습니다.")}catch(s){console.error("오류가 발생했습니다:",s)}}async function n(t){try{let a=await DBHelper.fnGetDataByKey(_STORE_NAME_PLAN,e);if(!a||!a.data.plan){console.error("계획 데이터를 찾을 수 없습니다.");return}let r=a.data.plan.find(e=>e.date===t);if(!r){console.error(`${t}에 해당하는 읽기 계획을 찾을 수 없습니다.`);return}return r.completed=!r.completed,console.log(`${t} 읽기 계획의 완료 상태가 ${r.completed?"완료":"미완료"}로 업데이트되었습니다.`),await DBHelper.fnSaveData(_STORE_NAME_PLAN,a)}catch(n){console.error("오류가 발생했습니다:",n)}}function l(e,a){return new Promise((r,n)=>{let l=[],s=new Date,c=e.length,p=0,h=d(s),f=Math.floor(c/a),g=c%a;for(;l.length<a&&p<c;){let $=u(s.getDay());if(t.readingDays.includes($)){let D=[],_=!1,w=o(s),m=d(s);m!==h&&(_=!0,h=m);let y=f;for(g>0&&(y++,g--);D.length<y&&p<c;){let v=`${e[p].bible}`;D.push(v),p++}let b=i(D);l.push({date:w,day:$,bible:b,completed:!1,newweek:_,category:e[p-1].category})}do s.setDate(s.getDate()+1);while(!t.readingDays.includes(u(s.getDay())))}l.length>0?r(l):n("No plan data was generated.")})}function i(e){if(0===e.length)return"";let a=[],r=null,n=null,l=null,i=null,o=null;if("01"===t.readingMethod)e.forEach((t,s)=>{if(!t||"string"!=typeof t){console.warn("Invalid entry found, skipping:",t);return}let u=t.split(" ");if(u.length<4||"~"!==u[2]){console.warn("Invalid format, skipping:",t);return}let d=u[0],c=u[1],p=u[3],[h,f]=c.split(":").map(Number),g=h,$=f;if(p&&p.includes(":")&&([g,$]=p.split(":").map(Number)),isNaN(h)||isNaN(f)||isNaN(g)||isNaN($)){console.warn("Invalid chapter/verse format, skipping:",c,p);return}r?r===d&&(h===i&&f===o+1||h===i+1&&1===f)?(i=g,o=$):(a.push(`${r} ${n}:${l} ~ ${i}:${o}`),r=d,n=h,l=f,i=g,o=$):(r=d,n=h,l=f,i=g,o=$),s===e.length-1&&a.push(`${r} ${n}:${l} ~ ${i}:${o}`)});else{if("05"===t.readingMethod)return e.forEach((t,s)=>{if(!t||"string"!=typeof t){console.warn("Invalid entry found, skipping:",t);return}let u=t.split(", ");u.forEach(e=>{let t=e.split(" ");if(t.length<4||"~"!==t[2]){console.warn("Invalid format, skipping:",e);return}let s=t[0],u=t[1],d=t[3],[c,p]=u.split(":").map(Number),h=c,f=p;if(d&&d.includes(":")&&([h,f]=d.split(":").map(Number)),isNaN(c)||isNaN(p)||isNaN(h)||isNaN(f)){console.warn("Invalid chapter/verse format, skipping:",u,d);return}r?r===s&&(c===i&&p===o+1||c===i+1&&1===p)?(i=h,o=f):(a.push(`${r} ${n}:${l} ~ ${i}:${o}`),r=s,n=c,l=p,i=h,o=f):(r=s,n=c,l=p,i=h,o=f)}),s===e.length-1&&a.push(`${r} ${n}:${l} ~ ${i}:${o}`)}),function e(t){let a=[],r=[],n=t.split(",").map(e=>e.trim());n.forEach(e=>{let t=e.indexOf(" "),r=e.slice(0,t),n=e.slice(t+1).trim();a.push({book:r,range:n})});let l={};return a.forEach(({book:e,range:t})=>{l[e]||(l[e]=[]),l[e].push(t)}),Object.keys(l).forEach(e=>{let t=l[e],[a,n]=t[0].split("~")[0].split(":").map(Number),[i,s]=t[0].includes("~")?t[0].split("~")[1].split(":").map(Number):[a,n];for(let o=1;o<t.length;o++){let u,d,c,p;if(t[o].includes("~")){let[h,f]=t[o].split("~").map(e=>e.trim());[u,d]=h.split(":").map(Number),[c,p]=f.split(":").map(Number)}else[u,d]=t[o].split(":").map(Number),c=u,p=d;u===i&&d===s+1||u===i+1&&1===d?(i=c,s=p):(r.push(`${e} ${a}:${n} ~ ${i}:${s}`),[a,n]=[u,d],[i,s]=[c,p])}r.push(`${e} ${a}:${n} ~ ${i}:${s}`)}),r.join(", ")}(a.join(", "));e.forEach((t,l)=>{if(!t||"string"!=typeof t)return;let o=t.split(", ");o.forEach(e=>{let t=e.split(" "),l=t[0],o=t.slice(1).join(" ").split("~").map(e=>e.trim()),u=parseInt(o[0].replace("장",""),10),d=o[1]?parseInt(o[1].replace("장",""),10):u;r?(r===l&&i+1===u||(a.push(s(r,n,i)),r=l,n=u),i=d):(r=l,n=u,i=d)}),l===e.length-1&&a.push(s(r,n,i))})}return a.join(", ")}function s(e,t,a){return t===a?`${e} ${t}장`:`${e} ${t}장 ~ ${a}장`}function o(e){return fnFormatDate(e,"yy.MM.dd")}function u(e){return["일","월","화","수","목","금","토"][e]}function d(e){let t=new Date(e.valueOf()),a=(e.getDay()+6)%7;t.setDate(t.getDate()-a+3);let r=new Date(t.getFullYear(),0,4);return 1+Math.round((t-r)/6048e5)}return{fnCreatePlanData:a,fnSaveReadingRecords:r,fnSaveReadingPlan:n,fnCalculateAverageTime:function e(t,a){let r=1558650/Math.floor(t/7*a),n=r/250;return{hours:Math.floor(n/60),minutes:Math.round(n%60),charactersPerDay:Math.round(r)}},fnCalculateRemainingDays:function e(t){let a=new Date,r=new Date(`20${t}`);return Math.ceil((r-a)/864e5)}}}();